# 访问计划算法说明

本文档基于仓库中实现的 `SiteScheduler`（位于 `visit_project/site_scheduler.py`）整理，说明数据格式、算法流程与实现细节，便于维护与重现。

## 概要

该项目旨在为给定的一组站点生成按天的访问计划。核心思想：按城市（city）和分包商（subcon）分簇，在每个簇内部尽可能将空间上接近（默认 5 公里以内）的站点配对，然后从城市中心向外按距离顺序安排每天的访问。

## 数据模型

每个站点由 `Site` 数据类表示，主要字段：

- `site_name`: 站点名称
- `latitude`, `longitude`: 经纬度（浮点）
- `city`: 城市（字符串，用于分簇）
- `easy_access`: 是否易于到达（用于地图标记）
- `subcon`: 分包商标识（用于分配队伍颜色/分组）
- `team_number`: 队伍数量（当前实现中默认 1）
- `date`: 调度后分配的访问日期（格式 YYYY-MM-DD，初始可为空）

CSV 读写函数：`load_sites_from_csv(filepath)` 会自动探测分隔符（`,` 或 `;`），并按照列头 `SiteName,Latitude,Longitude,City,EasyAccess,Subcon,TeamNumber,Date` 解析。

## 距离计算

使用 Haversine 公式计算两点之间的大圆距离（单位：公里）。实现函数为 `_haversine_distance(lat1, lon1, lat2, lon2)`，并由 `distance_between_sites(site1, site2)` 封装以便对 `Site` 对象调用。

## 算法步骤（高层）

1. 按 `city` 和 `subcon` 对站点进行分组，城市作为独立簇分别调度。
2. 对每个城市簇，计算城市中心点（所有站点经纬度的均值），作为该城市的“出发点”。
3. 在簇内查找所有两两距离 <= `max_pair_distance`（默认 5.0 km）的可能配对，按距离从近到远排序。
4. 使用贪心策略从这些候选配对中选择尽可能多的不重叠配对（即最大化配对数量，同时优先距离更近的配对）。
5. 调度顺序：从城市中心开始，每天选择距离城市中心最近的未分配站点
	 - 若该站点属于已选配对且其配对方仍未分配，则当天访问两个（先近后远）；
	 - 否则当天仅访问该单站点；
	 - 每安排一天后日期加 1（默认每队每天出发并返回）。
6. 为每个被安排访问的 `Site` 填写 `date` 字段，返回完整的站点列表和调度摘要（`get_schedule_summary()`）。

## 配对策略细节

- 先枚举所有符合距离阈值的候选配对并按距离升序排序。
- 然后进行一次贪心选择：遍历配对列表，若两个站点均未被其他已选配对占用，则将该配对加入最终配对集合。
- 该方式简单且常用于近似最大匹配问题（在本场景中优先保证配对数量且偏向更近的站点）。

## 约束与假设

- 每个城市对分包商队伍数量目前假定为 1（代码中 `team_count = 1`）。
- 默认最大配对距离为 5 公里，可通过构造 `SiteScheduler(sites, start_date, max_pair_distance=...)` 覆盖。
- 经纬度值会在 `load_sites_from_csv` 中进行简单校验（-90<=lat<=90, -180<=lon<=180）。

## 输出与可视化

- 调度结果可通过 `save_sites_to_csv(sites, filepath)` 保存为 CSV（分隔符为 `;`）。
- `generate_map(sites, output_file, scheduler)` 使用 `folium` 生成 HTML 地图：
	- 显示每个城市中心、各站点标注、按日期和队伍绘制路线；
	- 为每个 `subcon`+`city` 组合分配颜色；
	- 可视化访问顺序（城市内顺序和跨天连接线）。

## 复杂度（粗略估计）

- 枚举候选配对为 O(n^2)（n 为簇内站点数）；随后贪心选择线性遍历配对列表。
- 调度阶段通过重复排序未分配站点（按到城市中心距离），在最坏情况下也接近 O(n^2)。

## 建议与扩展

- 如果站点规模较大，可先按地理网格或 KD-tree 进行邻域搜索以降低配对枚举成本。
- 支持多队伍（`team_number` >1）时，需要在调度阶段引入队伍分配与并行日程合并逻辑。
- 为节约天数，可考虑改为按行程长度或工作时长约束分配每天访问的站点数，而不是固定“每天出发并返回”的假设。

## 实用命令示例

在仓库根目录，可运行 scripts 中的便捷脚本：

```bash
python3 scripts/run_scheduler.py example_sites.csv scheduled_sites.csv site_map.html 2025-01-01 5.0
```

参数依次为：输入 CSV、输出 CSV、地图输出 HTML、开始日期（可选）、最大配对距离（公里，可选）。

---

如需我将该文档进一步格式化或补充示意图与伪代码，我可以继续操作。
